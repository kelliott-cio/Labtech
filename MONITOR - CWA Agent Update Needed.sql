
INSERT INTO `Agents` (`Name`,`LocID`,`ClientID`,`ComputerID`,`DriveID`,`CheckAction`,`AlertAction`,`AlertMessage`,`ContactID`,`interval`,`Where`,`What`,`DataOut`,`Comparor`,`DataIn`,`LastScan`,`LastFailed`,`FailCount`,`IDField`,`AlertStyle`,`Changed`,`Last_Date`,`Last_User`,`ReportCategory`,`TicketCategory`,`Flags`,`GUID`,`AgentDefaultGUID`,`WarningCount`,`DeviceId`) Values('CWA AGENT - Needs Update','0','0','0','','0','1','%NAME% %STATUS% on %CLIENTNAME%\\%COMPUTERNAME% at %LOCATIONNAME% for %FIELDNAME% result %RESULT%.!!!%NAME% %STATUS% on %CLIENTNAME%\\%COMPUTERNAME% at %LOCATIONNAME% for %FIELDNAME% result %RESULT%.','1','3600','RAWSQL','RAWSQL','','0','',NOW(),NOW(),'0','','1','0',NOW(),USER(),'9','0','0','81fe7c64-2592-4a08-9461-38cf2ad5ba59','','0','0');
UPDATE `Agents` SET `Last_Date`=NOW(), `Last_User`=USER(),`DataOut`=REPLACE(REPLACE(REPLACE('Create Temporary Table IF NOT EXISTS Tcomp (INDEX (Computerid)) SELECT computerid FROM computers WHERE ComputerID NOT IN (Select ComputerID from AgentIgnore Where AgentID=INTERNALMONITORID)THISISASEMICOLON\r\n\r\nINSERT IGNORE INTO \`commands\` (computerid,command,parameters,fasttalk,dateupdated,output) \r\nSELECT DISTINCT c.computerid,\'1\' AS Command, v.serviceversion AS parameters, 0 AS Fasttalk, NOW() AS DateUpdated, \'\' AS Output\r\nFROM computers AS c\r\nJOIN (SELECT DISTINCT computers.computerid, IF(OS LIKE \'%WINDOWS%\' OR os LIKE \'%hyper-v%\',CONCAT(config.MajorVersion, \'.\', config.MinorVersion),IF(OS LIKE \'%OS X%\',macclientversion,linuxclientversion)) AS ServiceVersion\r\nFROM computers JOIN config) AS V ON v.computerid=c.computerid\r\nLEFT JOIN commands AS cmd ON cmd.computerid=c.computerid AND cmd.command=1 AND cmd.parameters=v.serviceversion AND (cmd.status<3 OR (cmd.status>=3 AND cmd.DateUpdated>DATE_ADD(NOW(),INTERVAL -1 DAY)))\r\nWHERE cmd.computerid IS NULL AND c.lastcontact>DATE_ADD(NOW(),INTERVAL -15 MINUTE) AND v.serviceversion<>c.serviceversion AND c.serviceversion>0 AND C.os NOT LIKE \'%2000%\' AND c.computerid IN (SELECT computerid FROM TComp) ORDER BY c.computerid LIMIT AGENTDEPLOYRATETHISISASEMICOLON\r\n\r\nSELECT DISTINCT c.serviceversion AS TestValue, v.serviceversion AS \`IdentityField\`, c.computerid, c.Name AS ComputerName, \r\nConvert(CONCAT(clients.name,\' \',locations.name) Using utf8) As Location, acd.NoAlerts, acd.UpTimeStart, acd.UpTimeEnd, c.lastcontact FROM computers AS c\r\nJOIN (SELECT DISTINCT computers.computerid, IF(OS LIKE \'%WINDOWS%\' OR os LIKE \'%hyper-v%\',CONCAT(config.MajorVersion, \'.\', config.MinorVersion),IF(OS LIKE \'%OS X%\',macclientversion,linuxclientversion)) AS ServiceVersion\r\nFROM computers JOIN config) AS V ON v.computerid=c.computerid\r\nLEFT JOIN Locations ON Locations.LocationID=C.Locationid LEFT JOIN Clients ON Clients.ClientID=C.clientid \r\nJOIN AgentComputerData AS acd ON c.ComputerID=acd.ComputerID\r\nLEFT JOIN commands AS cmd ON cmd.computerid=c.computerid AND cmd.command=1 AND cmd.parameters=v.serviceversion AND (cmd.status>=3 OR (cmd.status<3 AND cmd.DateUpdated<DATE_ADD(NOW(),INTERVAL -5 MINUTE)))\r\nWHERE v.serviceversion<>c.serviceversion AND c.serviceversion>0 AND C.os NOT LIKE \'%2000%\' AND c.lastcontact>DATE_ADD(NOW(),INTERVAL -15 MINUTE) AND c.computerid IN (SELECT computerid FROM TComp)','INTERNALMONITORID',`AgentID`),'AGENTDEPLOYRATE',10*CEILING((SELECT COUNT(*) FROM COMPUTERS)/240)),'THISISASEMICOLON',CHAR(59)) WHERE `GUID`='81fe7c64-2592-4a08-9461-38cf2ad5ba59';
