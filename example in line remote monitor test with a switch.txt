 -noprofile -command "& {$MVer=7.22;$ProgressPreference='SilentlyContinue';IF (-not ($psversiontable.psversion -gt 1.9)) {'Error:POSH 2.0+ Required';exit};$tpvalue='{%25^tp:kbid_ms17_010^%25}';$Errs={}.Invoke();$Outs={}.Invoke();$KBLIST=@{};$KBResult=@();$i=0;$r=0;$h=0;$k=0;try {$WUSess=New-Object -ComObject 'Microsoft.Update.Session';$WUSearch=$WUSess.CreateUpdateSearcher();$FormatEnumerationLimit=-1;$WUHist=$WUSearch.GetTotalHistoryCount();if ($WUHist -gt 0) {$Outs.Add('Loading Windows Update History');$WUSearch.QueryHistory(0, $WUHist)|Select-Object Title,Date,Operation,Resultcode|Where-Object {$_.Operation -match '[12]' -and $_.Resultcode -match '[123]' -and $_.Date -gt '1/1/1980'}|Sort-Object Date,Title|ForEach-Object {$Title=$_.Title;$KBID=$($Title|Select-String 'KB\d{6,7}' -AllMatches|ForEach-Object{$_.matches}|ForEach-Object {$_.Value});IF($KBID) {switch($_.operation){1{$Outs.Add('Adding '+$KBID+': '+$Title);$i+=1;$KBLIST.Set_Item($KBID,$Title)};2{$Outs.Add('Removing '+$KBID);$r+=1;$KBLIST.Remove($KBID)}}}}} else {$Errs.Add('Windows Update History Unavailable')}} catch {$Errs.Add('Error retrieving Windows Update History')};try {$Outs.Add('Loading Get-Hotfix Reported Updates');Get-Hotfix|ForEach-Object {$KBID=$_.HotfixID;IF($KBID -match 'KB\d{6,7}') {$h+=1;if (-not $KBLIST.ContainsKey($KBID)) {$Outs.Add('Adding '+$KBID);$k+=1;$KBLIST.Set_Item($KBID,$KBID)} else {$Outs.Add($KBID+' already found')}}}} catch {$Errs.Add('Error retrieving Get-Hotfix results')};$Outs.Add('Filtering Updates');$KBLIST.GetEnumerator()|sort-object|Where-Object {($_.Value -match 'KB('+$tpvalue+')' -and $tpvalue.Length -gt 25) -or ( $_.Value -match '^((2017-0[3-9]|2017-1[0-2]|201[89]-[0-9]{2})|(Ma|A|Ju|[SOND][^ ]+ber).* 2017 |[a-z]{3,10} 201[89] )' -and $_.Value -match '(Security .*Rollup|Cumulative Update) for Windows')}|ForEach-Object {$Outs.Add('Successfully Matched '+$_.Name);$KBResult+=$_.Name};IF (-not $($tpvalue.Length -gt 25)) {$Errs.Add('Error - Template Property kbid_ms17_010 not found')};IF([version][System.Environment]::OSVersion.Version -ge [version]'10.0.15063'){$KBResult+=$KBID='Win10 10.0.15063+';$Outs.Add('Override - Detected '+$KBID)};IF ('{%25^tp:kbid_ms17_010_debug^%25}' -eq 1) {'Windows Update - '+$i+' installed, '+$r+' removed';'Get-Hotfix - '+$k+'/'+$h+' hotfixes added.';'Matched Updates: '+$KBResult.Count;$Outs.GetEnumerator()};IF ($KBResult) {'Secured - Detected Updates '+$($KBResult)|Out-String} else {'Vulnerable - No Matching KB Found.';$Errs.GetEnumerator()}}"